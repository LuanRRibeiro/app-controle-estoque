<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Previs√£o de Vendas</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- (Opcional) Font Awesome -->
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

  <link rel="icon" href="/static/imagem/icone.ico" type="image/x-icon">

  <style>
    .card { border-radius: 12px; }
    .card-header { border-top-left-radius: 12px; border-top-right-radius: 12px; }
    canvas { max-width: 100%; height: 320px; }

    /* pagina√ß√£o: mant√©m compacto em telas menores */
    .pagination { flex-wrap: wrap; gap: 4px; }
    .page-link { min-width: 40px; text-align: center; }
  </style>
</head>
<body>
  {% include 'navbar.html' %}

  <!-- Tela de carregamento -->
  <div id="loading" style="position:fixed;top:0;left:0;width:100%;height:100%;
       background:rgba(255,255,255,0.9);display:flex;justify-content:center;align-items:center;z-index:9999;">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="mt-3 fs-5 text-dark">Aguarde, preparando as previs√µes...</p>
    </div>
  </div>

  <!-- Conte√∫do principal -->
  <main class="container mt-5 mb-5" style="padding-top: 20px; display:none;" id="conteudo">
    <h2 class="text-center mb-2">üìà Previs√£o de Vendas</h2>

    <!-- Legenda -->
    <div class="text-center mb-4">
      <span class="badge bg-primary me-2" data-bs-toggle="tooltip" data-bs-placement="top"
            title="Previs√£o (yhat): valor central estimado pelo modelo.">Previs√£o (yhat)</span>
      <span class="badge bg-danger me-2" data-bs-toggle="tooltip" data-bs-placement="top"
            title="Limite Inferior (95%).">Limite Inferior</span>
      <span class="badge bg-success" data-bs-toggle="tooltip" data-bs-placement="top"
            title="Limite Superior (95%).">Limite Superior</span>
    </div>

    <!-- Produtos -->
    <div id="produtos-container" class="row gy-4"></div>

    <!-- Pagina√ß√£o (servidor) -->
    <nav aria-label="Pagina√ß√£o produtos">
      <ul class="pagination justify-content-center mt-4" id="paginacao-produtos"></ul>
    </nav>

    <!-- √Årea para mostrar erros amig√°veis -->
    <div id="erro-area" class="mt-3"></div>
  </main>

  <script>
    // ---- Vari√°veis vindas do backend (com fallback seguro) ----
    const previsoes    = {{ (previsoes or {}) | tojson }};
    const paginaAtual  = {{ pagina | int }};
    const totalPaginas = {{ total_paginas | int }};
    const diasFuturos  = {{ dias_futuros | default(30) | int }};

    // Tooltips Bootstrap
    const tooltipEls = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipEls.forEach(el => new bootstrap.Tooltip(el));

    function renderizarGraficos() {
      const container = document.getElementById('produtos-container');
      container.innerHTML = '';

      const ids = Object.keys(previsoes || {});
      if (ids.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="alert alert-info text-center" role="alert">
              Nenhum produto nesta p√°gina.
            </div>
          </div>`;
        return;
      }

      ids.forEach(produto_id => {
        const serie = previsoes[produto_id] || [];
        const card = document.createElement('div');
        card.className = 'col-12 col-md-6';

        card.innerHTML = `
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white d-flex align-items-center justify-content-between">
              <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Produto ${produto_id}</h5>
              <small>Pr√≥ximos ${diasFuturos} dias</small>
            </div>
            <div class="card-body">
              <canvas id="grafico-produto-${produto_id}" height="200" aria-label="Gr√°fico do produto ${produto_id}"></canvas>
            </div>
          </div>
        `;
        container.appendChild(card);

        try {
          const labels = serie.map(p => p.ds);
          const yhat   = serie.map(p => Math.max(p.yhat, 0));
          const low    = serie.map(p => Math.max(p.yhat_lower, 0));
          const up     = serie.map(p => Math.max(p.yhat_upper, 0));

          const ctx = document.getElementById(`grafico-produto-${produto_id}`).getContext('2d');
          new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [
                { label: 'Previs√£o (yhat)', data: yhat, borderWidth: 2, tension: 0.25, borderColor: 'rgb(54, 162, 235)', fill: false },
                { label: 'Limite Inferior', data: low,  borderWidth: 1, tension: 0.25, borderDash: [5,5], borderColor: 'rgba(255,99,132,0.7)', fill: false },
                { label: 'Limite Superior', data: up,   borderWidth: 1, tension: 0.25, borderDash: [5,5], borderColor: 'rgba(75,192,192,0.7)', fill: false }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true },
                title:  { display: false }
              },
              interaction: { mode: 'index', intersect: false },
              scales: {
                x: { title: { display: true, text: 'Data' } },
                y: { title: { display: true, text: 'Quantidade' }, beginAtZero: true }
              }
            }
          });
        } catch (e) {
          console.error(e);
          document.getElementById('erro-area').innerHTML = `
            <div class="alert alert-warning">
              Falha ao desenhar gr√°fico do produto ${produto_id}. Detalhes no console.
            </div>`;
        }
      });
    }

    // Pagina√ß√£o condensada: mostra poucas p√°ginas + retic√™ncias
    function renderizarPaginacao() {
      const ul = document.getElementById('paginacao-produtos');
      ul.innerHTML = '';

      const link = (p, label, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = 'page-item' + (disabled ? ' disabled' : '') + (active ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="?pagina=${p}&dias=${diasFuturos}">${label}</a>`;
        ul.appendChild(li);
      };
      const ellipsis = () => {
        const li = document.createElement('li');
        li.className = 'page-item disabled';
        li.innerHTML = `<span class="page-link">‚Ä¶</span>`;
        ul.appendChild(li);
      };

      const total = Math.max(1, totalPaginas);
      const atual = Math.min(Math.max(1, paginaAtual), total);

      link(Math.max(1, atual - 1), '¬´', atual === 1);

      // primeira
      link(1, '1', false, atual === 1);

      // janela central
      const start = Math.max(2, atual - 2);
      const end   = Math.min(total - 1, atual + 2);

      if (start > 2) ellipsis();
      for (let p = start; p <= end; p++) {
        link(p, String(p), false, p === atual);
      }
      if (end < total - 1) ellipsis();

      // √∫ltima
      if (total > 1) link(total, String(total), false, atual === total);

      link(Math.min(total, atual + 1), '¬ª', atual === total);
    }

    function iniciarPagina() {
      try {
        renderizarGraficos();
        renderizarPaginacao();
      } catch (e) {
        console.error(e);
        document.getElementById('erro-area').innerHTML = `
          <div class="alert alert-danger">Erro ao montar a p√°gina: ${e}</div>`;
      } finally {
        // garante que o overlay some mesmo se houver erro
        document.getElementById('loading').style.display = 'none';
        document.getElementById('conteudo').style.display = 'block';
      }
    }

    // Pequeno atraso s√≥ para UX do "loading"
    setTimeout(iniciarPagina, 120);
  </script>
</body>
</html>
